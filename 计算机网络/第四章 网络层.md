## 网络层

### 4.1 网络层提供的两种服务
虚电路服务与数据报服务

虚电路服务：可靠通信应当由网络保证，需要建立连接；
数据报服务：可靠通信由用户主机保证，不需要建立连接；

### 4.2 网际协议IP
与IP协议配套使用的协议：ARP、RARP、ICMP、IGMP；

4.2.1 虚拟互连网络

4.2.2 分类的IP地址
IP地址的编址方法的三个阶段：
  分类的IP地址：
    A类：类别位：0
    B类：类别位：10
    C类：类别位：110
  主机号分别为三个字节、两个字节、一个字节；

网络号全0的IP地址的含义：是保留地址，意思是“本网络”；
网络号全1：本地软件环回测试本主机之间的进程之间的通信使用；
主机号全0：表示该IP地址是本主机所连接到的单个网络地址；
主机号全1：表示“所有的”，表示该网络上的所有主机；

  子网的划分；
  构成超网；

4.2.3 IP地址与硬件地址
IP地址放在IP数据报的首部，而硬件地址则放在MAC帧的首部。在网络层和网络层以上使用的是IP地址，而数据链路层及以下使用的是硬件地址。

4.2.4 地址解析协议ARP和逆地址解析协议RARP
ARP：IP地址 -> 物理地址，在主机ARP缓存中存放一个从IP地址到硬件地址的映射表，这个映射表经常动态更新；
  ARP是解决同一个局域网d上的主机或路由器的IP地址向硬件地址的映射问题；
RARP：物理地址 -> IP地址

4.2.5 IP数据报的格式
首部20字节固定的

4.2.6 IP层转发分组的流程

### 4.3 划分子网和构造超网

4.3.1 划分子网
划分子网：从网络的主机号借用若干位变成子网号，划分子网后IP地址变成了三级结构；

子网掩码：子网掩码中的1代表IP地址中原来的网络号+子网号，0代表现在的主机号；

4.3.2 使用子网时分组的转发
划分子网后，路由表包含的内容：目的网络地址、子网掩码和下一跳地址；

(!) 路由器转发分组的算法
  1）从收到数据包的首部提取目的IP地址D
  2）先判断是否为直接交付。对路由器直接相连的网络逐个进行检查：用各网络的子网掩码和D逐位相与，看是否和相应的网络地址匹配。若匹配，则把分组直接交付，转发任务结束。否则是间接交付，执行（3）；
  3）若路由器有目的地址为D的特定主机路由，则把数据报传送给路由表中指明的下一跳路由器；否则，执行（4）
  4）对路由表中的每一行（目的网络地址，子网掩码，下一跳地址)，用其中的子网掩码和D逐位相“与”(AND操作)，其结果为N。若N与该行的目的网络地址匹配，则把数据报传送给该行指明的下一跳路由器;否则，执行(5)。
  5）若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器;否则，执行(6)。
  6）报告转发分组出错。

4.3.3 无分类编制CIDR
IP地址 = 网络前缀 + 主机号 128.14.32.0/20 CIDR地址块

CIDR地址块有很多地址，在路由表中利用CIDR地址块来查找目的网络，这样的地址的聚合成为路由聚合。
路由聚合也称构成超网。

最长前缀匹配：
  从路由表中的匹配结果选择具有最长网络前缀的路由；

4.4 网际控制报文协议ICMP

4.4.1ICMP报文的种类
种类：ICMP差错报告报文和ICMP询问报文；

ICMP差错报文：
  终点不可达；
  源点抑制；
  时间超过；
  参数问题；
  改变路由（重定向）；

ICMP询问报文：
  回送请求和回答：为了测试目的站是否可达以及了解有关状态。PING
  时间戳请求和回答：请某个主机或路由器回答当前的日期和时间；

4.4.2 ICMP的应用举例
PING
traceroute

### 4.5 因特网的路由选择协议

4.5.1 有关路由选择协议的几个基本概念
  自治系统
  内部网关协议IGP
  外部网关协议EGP
  域间路由选择
  域内路由选择

4.5.2 内部网关协议RIP
  基于距离向量的路由选择协议；
  仅和相邻的路由器交换信息，交换当前本路由器知道的全部信息，按固定的时间间隔交换路由信息；
  简单，基于跳数，一条路径最多只能包含15个路由器，适用于小型互联网；
  RIP不能在两个网络之间同时使用多条路由，RIP选择一条具有最少路由器的路由；
  RIP协议路由表更新的原则是找出到每个目的网络的最短距离，这种更新算法又称为距离向量算法；
  RIP使用UDP进行传送，RIP报文最大长度4+20*25=504

4.5.3 内部网关协议OSPF
协议的基本特点、报文格式、工作原理、分组类型

  使用分布式的链路状态协议；
  向本自治系统的所有路由器发送信息，发送与本路由器相邻的所有路由器的链路状态，只有当链路状态发生变化时才发送信息；
  OSPF直接用IP数据报传送；

  OSPF有五种分组类型：
    类型1：问候分组，发现与维持邻站的可达性；
    类型2：数据库描述分组，向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
    类型3：链路状态请求分组，向对方请求发送某些链路状态项目的详细信息。
    类型4：链路状态更新分组，用洪泛法对全网更新链路状态。
    类型5：链路状态确认分组，对链路更新分组的确认。

4.5.4 外部网关协议BGP
  采用路径向量路由选择协议；
  BGP-4的四种报文：
  (1) OPEN(打开）报文，用来与相邻的另一个BGP发言人建立关系，使通信初始化。
  (2)UPDATE（更新）报文，用来通告某一路由的信息，以及列出要撤消的多条路由。
  (3) KEEPALIVE（保活）报文，用来周期性地证实邻站的连通性。
  (4) NOTIFICATION（通知）报文，用来发送检测到的差错。
  在RFC 2918中增加了ROUTE-REFRESH报文，用来请求对等端重新通告。

4.5.5 路由器的构成
路由器的结构

4.6 IP多播

4.6.1 IP多播的概念
局域网具有硬件多播的功能；
多播组的标识符是IP地址中的D类地址； 1110-多播地址，只能用于目的地址，不能用于源地址；

4.6.2 在局域网上进行硬件多播
48位的以太网地址的低23位来自D类IP地址；

4.6.3 网际组管理协议IGMP和多播路由选择协议
IGMP协议：
  IGMP协议是让连接在本地局域网上的多播路由器知道本局域网上是否有主机；

多播数据报可以由没有加入多播组的主机发出，也可以通过没有组成员接入的网络；

多播路由选择协议：
  转发数据报时采用的方法：洪泛与剪除；隧道技术；基于核心的发现技术；
  CBT、MOSPF、PIM-SM、PIM-DM

4.7 虚拟专用网VPN和网络地址转换NAT
4.7.1 虚拟专用网 VPN

4.7.2 网络地址转换NAT